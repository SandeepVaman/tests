 name: Auto Merge Specific Folders

  on:
    pull_request:
      types: [opened, synchronize, reopened]
      branches:
        - main

  permissions:
    contents: read

  jobs:
    auto-merge:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Get changed files
          id: changed_files
          run: |
            FILES=$(gh pr diff ${{ github.event.pull_request.number }} --name-only)
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        - name: Check if only safe paths changed
          id: check_safe
          run: |
            SAFE=true
            while IFS= read -r file; do
              if [[ ! "$file" =~ ^docs/ && ! "$file" =~ ^assets/ ]]; then
                echo "Unsafe file: $file"
                SAFE=false
                break
              fi
            done <<< "${{ steps.changed_files.outputs.files }}"
            echo "safe=$SAFE" >> $GITHUB_OUTPUT

        - name: Generate GitHub App token
          if: steps.check_safe.outputs.safe == 'true'
          id: app_token
          uses: actions/create-github-app-token@v1
          with:
            app-id: ${{ secrets.APP_ID }}
            private-key: ${{ secrets.APP_PRIVATE_KEY }}

        - name: Approve PR
          if: steps.check_safe.outputs.safe == 'true'
          run: |
            gh pr review ${{ github.event.pull_request.number }} --approve --body "Auto-approved: changes only in docs/ or assets/"
          env:
            GH_TOKEN: ${{ steps.app_token.outputs.token }}

        - name: Enable auto-merge
          if: steps.check_safe.outputs.safe == 'true'
          run: |
            gh pr merge ${{ github.event.pull_request.number }} --merge --auto
          env:
            GH_TOKEN: ${{ steps.app_token.outputs.token }}